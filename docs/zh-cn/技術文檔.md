# MakanMakan æŠ€è¡“æ–‡ä»¶
## åŸºæ–¼ Cloudflare ç”Ÿæ…‹ç³»çµ±çš„æ¶æ§‹è¨­è¨ˆ

**ç‰ˆæœ¬**: v1.1  
**æœ€å¾Œæ›´æ–°**: 2025å¹´8æœˆ31æ—¥  
**æŠ€è¡“è² è²¬äºº**: é–‹ç™¼åœ˜éšŠ  
**å°ˆæ¡ˆç‹€æ…‹**: ğŸš€ ç”Ÿç”¢å°±ç·’

---

## ğŸ¯ æŠ€è¡“éœ€æ±‚æ¦‚è¿°

åŸºæ–¼ç”¢å“éœ€æ±‚æ–‡ä»¶ï¼ˆPRDï¼‰åˆ†æï¼Œç³»çµ±éœ€è¦æ»¿è¶³ä»¥ä¸‹æ ¸å¿ƒæŠ€è¡“éœ€æ±‚ï¼š
- **é«˜å¯ç”¨æ€§**: >99.9% æ­£å¸¸é‹è¡Œæ™‚é–“
- **ä½å»¶é²**: API å›æ‡‰æ™‚é–“ P99 < 300ms
- **å…¨çƒéƒ¨ç½²**: æ”¯æ´äºå¤ªåœ°å€ä½¿ç”¨è€…
- **å³æ™‚æ€§**: è¨‚å–®ç‹€æ…‹å³æ™‚åŒæ­¥
- **æ“´å±•æ€§**: æ”¯æ´ 1000+ QPS
- **å®‰å…¨æ€§**: ä¼æ¥­ç´šè³‡æ–™ä¿è­·
- **æˆæœ¬æ•ˆç›Š**: ç„¡ä¼ºæœå™¨æ¶æ§‹ï¼ŒæŒ‰éœ€ä»˜è²»
- **ç¨‹å¼ç¢¼å“è³ª**: TypeScript 100% ç·¨è­¯ç„¡éŒ¯èª¤

---

## ğŸ—ï¸ ç³»çµ±æ¶æ§‹è¨­è¨ˆ

### ç¸½é«”æ¶æ§‹åœ–
```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   Cloudflare CDN    â”‚
                        â”‚   + WAF + DDoS      â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                  â”‚                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ å®¢æˆ¶æ‡‰ç”¨ç¨‹å¼    â”‚  â”‚  ç®¡ç†æ‡‰ç”¨ç¨‹å¼  â”‚  â”‚   QR ç¢¼      â”‚
        â”‚ (Pages)       â”‚  â”‚  (Pages)     â”‚  â”‚  ç”¢ç”Ÿå™¨       â”‚
        â”‚ Vue.js 3      â”‚  â”‚  Vue.js      â”‚  â”‚  (Workers)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   API é–˜é“å™¨        â”‚
                        â”‚ (Cloudflare Workers)â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                          â”‚                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è³‡æ–™åº«      â”‚        â”‚  å¿«å–èˆ‡ç‹€æ…‹      â”‚        â”‚  æª”æ¡ˆå„²å­˜        â”‚
â”‚ (Cloudflare  â”‚        â”‚ (KV + Durable   â”‚        â”‚ (R2 + Images)   â”‚
â”‚     D1)      â”‚        â”‚    Objects)     â”‚        â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                          â”‚                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åˆ†æå·¥å…·    â”‚        â”‚  è¨Šæ¯ä½‡åˆ—       â”‚        â”‚   ç›£æ§          â”‚
â”‚ Analytics +  â”‚        â”‚ (Cloudflare     â”‚        â”‚ (Workers        â”‚
â”‚ Web Analyticsâ”‚        â”‚    Queues)      â”‚        â”‚  Analytics)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Cloudflare æœå‹™æ˜ å°„è¡¨

| åŠŸèƒ½éœ€æ±‚ | Cloudflare æœå‹™ | ä¸»è¦ç”¨é€” |
|---------|---------------|----------|
| å‰ç«¯æ‡‰ç”¨éƒ¨ç½² | **Cloudflare Pages** | SPA è¨—ç®¡ã€é è¦½ç’°å¢ƒã€è‡ªå‹•éƒ¨ç½² |
| å¾Œç«¯ API æœå‹™ | **Cloudflare Workers** | ç„¡ä¼ºæœå™¨è¨ˆç®—ã€é‚Šç·£è™•ç† |
| è³‡æ–™åº«æœå‹™ | **Cloudflare D1** | ç„¡ä¼ºæœå™¨ SQL è³‡æ–™åº« |
| å¿«å–ç³»çµ± | **Cloudflare KV** | èœå–®å¿«å–ã€è¨­å®šå„²å­˜ |
| å³æ™‚åŠŸèƒ½ | **Durable Objects** | WebSocket é€£æ¥ã€ç‹€æ…‹ç®¡ç† |
| æª”æ¡ˆå„²å­˜ | **Cloudflare R2** | åœ–ç‰‡åŸå§‹æª”æ¡ˆå„²å­˜ |
| åœ–ç‰‡è™•ç† | **Cloudflare Images** | è‡ªå‹•æœ€ä½³åŒ–ã€å¤šå°ºå¯¸è®Šå½¢ |
| ä»»å‹™ä½‡åˆ— | **Cloudflare Queues** | éåŒæ­¥ä»»å‹™è™•ç† |
| å®‰å…¨é˜²è­· | **Cloudflare WAF** | DDoSã€Bot é˜²è­·ã€å­˜å–æ§åˆ¶ |
| æ•ˆèƒ½ç›£æ§ | **Workers Analytics** | API æ•ˆèƒ½ã€éŒ¯èª¤è¿½è¹¤ |
| ä½¿ç”¨è€…åˆ†æ | **Web Analytics** | ä½¿ç”¨è€…è¡Œç‚ºã€é é¢æ•ˆèƒ½ |

---

## ğŸ’¾ è³‡æ–™åº«è¨­è¨ˆ (Cloudflare D1)

### è³‡æ–™åº«æ¶æ§‹

#### æ ¸å¿ƒè³‡æ–™è¡¨è¨­è¨ˆ

```sql
-- ä½¿ç”¨è€…è¡¨ï¼ˆå¤šè§’è‰²æ”¯æ´ï¼‰
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    name TEXT NOT NULL,
    role INTEGER NOT NULL DEFAULT 1,
    -- 0: ç®¡ç†å“¡, 1: åº—ä¸», 2: å»šå¸«, 3: æœå‹™å“¡, 4: æ”¶éŠ€å“¡
    restaurant_id INTEGER,
    status INTEGER DEFAULT 1, -- 1: å•Ÿç”¨, 0: åœç”¨
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (restaurant_id) REFERENCES restaurants(id)
);

-- é¤å»³è¡¨
CREATE TABLE restaurants (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    address TEXT,
    phone TEXT,
    email TEXT,
    business_hours TEXT, -- JSON æ ¼å¼å„²å­˜ç‡Ÿæ¥­æ™‚é–“
    settings TEXT, -- JSON æ ¼å¼å„²å­˜é¤å»³è¨­å®š
    status INTEGER DEFAULT 1, -- 1: å•Ÿç”¨, 0: åœç”¨
    plan_type INTEGER DEFAULT 0, -- 0: å…è²», 1: åŸºæœ¬, 2: å°ˆæ¥­
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- æ¡Œå°è¡¨
CREATE TABLE tables (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    restaurant_id INTEGER NOT NULL,
    table_number INTEGER NOT NULL,
    table_name TEXT,
    capacity INTEGER DEFAULT 4,
    qr_code TEXT UNIQUE, -- QR Code å…§å®¹
    status INTEGER DEFAULT 0, -- 0: å¯ç”¨, 1: ä½¿ç”¨ä¸­, 2: é ç´„
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (restaurant_id) REFERENCES restaurants(id),
    UNIQUE(restaurant_id, table_number)
);

-- åˆ†é¡è¡¨
CREATE TABLE categories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    restaurant_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    sort_order INTEGER DEFAULT 0,
    status INTEGER DEFAULT 1, -- 1: å•Ÿç”¨, 0: åœç”¨
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (restaurant_id) REFERENCES restaurants(id)
);

-- èœå–®é …ç›®è¡¨
CREATE TABLE menu_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    restaurant_id INTEGER NOT NULL,
    category_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    image_url TEXT,
    image_variants TEXT, -- JSON æ ¼å¼å„²å­˜ä¸åŒå°ºå¯¸åœ–ç‰‡ URL
    options TEXT, -- JSON æ ¼å¼å„²å­˜å®¢è£½åŒ–é¸é …ï¼ˆç”œåº¦ã€å†°å¡Šç­‰ï¼‰
    sort_order INTEGER DEFAULT 0,
    is_available INTEGER DEFAULT 1,
    inventory_count INTEGER DEFAULT -1, -- -1 è¡¨ç¤ºä¸é™é‡
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (restaurant_id) REFERENCES restaurants(id),
    FOREIGN KEY (category_id) REFERENCES categories(id)
);

-- è¨‚å–®è¡¨
CREATE TABLE orders (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    restaurant_id INTEGER NOT NULL,
    table_id INTEGER NOT NULL,
    order_number TEXT UNIQUE NOT NULL,
    customer_name TEXT,
    customer_phone TEXT,
    total_amount DECIMAL(10,2) NOT NULL,
    status INTEGER DEFAULT 0,
    -- 0: å¾…è™•ç†, 1: å·²ç¢ºèª, 2: è£½ä½œä¸­, 3: å·²å®Œæˆ, 4: å·²é€é”, 5: å·²ä»˜æ¬¾, 6: å·²å–æ¶ˆ
    payment_status INTEGER DEFAULT 0, -- 0: å¾…ä»˜æ¬¾, 1: å·²ä»˜æ¬¾, 2: ä»˜æ¬¾å¤±æ•—
    payment_method TEXT, -- cash, card, online
    notes TEXT,
    estimated_time INTEGER, -- é ä¼°è£½ä½œæ™‚é–“ï¼ˆåˆ†é˜ï¼‰
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (restaurant_id) REFERENCES restaurants(id),
    FOREIGN KEY (table_id) REFERENCES tables(id)
);

-- è¨‚å–®é …ç›®è¡¨
CREATE TABLE order_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    order_id INTEGER NOT NULL,
    menu_item_id INTEGER NOT NULL,
    quantity INTEGER NOT NULL DEFAULT 1,
    unit_price DECIMAL(10,2) NOT NULL,
    total_price DECIMAL(10,2) NOT NULL,
    customizations TEXT, -- JSON æ ¼å¼å„²å­˜å®¢è£½åŒ–é¸é …
    notes TEXT,
    status INTEGER DEFAULT 0, -- 0: å¾…è™•ç†, 1: è£½ä½œä¸­, 2: å·²å®Œæˆ, 3: å·²é€é”
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (order_id) REFERENCES orders(id),
    FOREIGN KEY (menu_item_id) REFERENCES menu_items(id)
);

-- QR ç¢¼è¡¨
CREATE TABLE qr_codes (
    id TEXT PRIMARY KEY,
    content TEXT NOT NULL,
    format TEXT NOT NULL DEFAULT 'png',
    style_json TEXT, -- JSON æ ¼å¼å„²å­˜æ¨£å¼è¨­å®š
    metadata_json TEXT, -- JSON æ ¼å¼å„²å­˜å…ƒè³‡æ–™
    url TEXT, -- ç”Ÿæˆçš„ QR ç¢¼ URL
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- QR ç¢¼æ¨¡æ¿è¡¨
CREATE TABLE qr_templates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    category TEXT NOT NULL,
    style_json TEXT NOT NULL, -- JSON æ ¼å¼å„²å­˜æ¨£å¼è¨­å®š
    is_default BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    created_by INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- QR ç¢¼ä¸‹è¼‰è¨˜éŒ„è¡¨
CREATE TABLE qr_downloads (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    qr_code_id TEXT NOT NULL,
    format TEXT NOT NULL,
    ip_address TEXT,
    user_agent TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (qr_code_id) REFERENCES qr_codes(id)
);

-- QR ç¢¼æ‰¹æ¬¡è¡¨
CREATE TABLE qr_batches (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    batch_id TEXT UNIQUE NOT NULL,
    restaurant_id INTEGER,
    total_codes INTEGER NOT NULL,
    generated_codes INTEGER DEFAULT 0,
    status TEXT DEFAULT 'pending', -- pending, processing, completed, failed
    created_by INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (restaurant_id) REFERENCES restaurants(id),
    FOREIGN KEY (created_by) REFERENCES users(id)
);

-- æœƒè©±è¡¨ï¼ˆå¯é¸ï¼Œä¹Ÿå¯ä½¿ç”¨ Cloudflare KVï¼‰
CREATE TABLE sessions (
    id TEXT PRIMARY KEY,
    user_id INTEGER,
    restaurant_id INTEGER,
    data TEXT, -- JSON æ ¼å¼å„²å­˜æœƒè©±è³‡æ–™
    expires_at DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (restaurant_id) REFERENCES restaurants(id)
);

-- ç¨½æ ¸æ—¥èªŒè¡¨ï¼ˆå¯©è¨ˆç”¨é€”ï¼‰
CREATE TABLE audit_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    restaurant_id INTEGER,
    action TEXT NOT NULL,
    resource TEXT NOT NULL,
    resource_id TEXT,
    description TEXT NOT NULL,
    changes TEXT, -- JSON æ ¼å¼å„²å­˜è®Šæ›´è©³æƒ…
    ip_address TEXT,
    user_agent TEXT,
    success BOOLEAN NOT NULL DEFAULT TRUE,
    error_message TEXT,
    execution_time_ms INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (restaurant_id) REFERENCES restaurants(id)
);

-- éŒ¯èª¤å ±å‘Šè¡¨
CREATE TABLE error_reports (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER,
    restaurant_id INTEGER,
    error_type TEXT NOT NULL,
    severity TEXT NOT NULL, -- low, medium, high, critical
    error_code TEXT,
    error_message TEXT NOT NULL,
    error_context TEXT, -- JSON æ ¼å¼
    original_error TEXT, -- JSON æ ¼å¼å„²å­˜åŸå§‹éŒ¯èª¤
    user_agent TEXT,
    url TEXT,
    timestamp DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (restaurant_id) REFERENCES restaurants(id)
);

-- åœ–ç‰‡è¡¨
CREATE TABLE images (
    id TEXT PRIMARY KEY,
    restaurant_id INTEGER,
    type TEXT NOT NULL, -- menu, avatar, etc.
    original_name TEXT,
    file_path TEXT NOT NULL,
    file_size INTEGER,
    mime_type TEXT,
    metadata TEXT, -- JSON æ ¼å¼
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (restaurant_id) REFERENCES restaurants(id)
);

-- åœ–ç‰‡è®Šé«”è¡¨
CREATE TABLE image_variants (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    image_id TEXT NOT NULL,
    variant_name TEXT NOT NULL, -- thumbnail, medium, large
    width INTEGER,
    height INTEGER,
    url TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (image_id) REFERENCES images(id)
);
```

#### ç´¢å¼•è¨­è¨ˆ

```sql
-- æ•ˆèƒ½é—œéµç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_restaurant_role ON users(restaurant_id, role);
CREATE INDEX idx_tables_restaurant ON tables(restaurant_id);
CREATE INDEX idx_tables_qr_code ON tables(qr_code);
CREATE INDEX idx_categories_restaurant ON categories(restaurant_id);
CREATE INDEX idx_menu_items_restaurant_category ON menu_items(restaurant_id, category_id);
CREATE INDEX idx_menu_items_available ON menu_items(restaurant_id, is_available);
CREATE INDEX idx_orders_restaurant_status ON orders(restaurant_id, status);
CREATE INDEX idx_orders_table_status ON orders(table_id, status);
CREATE INDEX idx_orders_created_at ON orders(created_at);
CREATE INDEX idx_order_items_order ON order_items(order_id);
CREATE INDEX idx_sessions_expires ON sessions(expires_at);
CREATE INDEX idx_audit_logs_restaurant_created ON audit_logs(restaurant_id, created_at);
CREATE INDEX idx_qr_codes_created_at ON qr_codes(created_at);
CREATE INDEX idx_qr_templates_active ON qr_templates(is_active, category);
CREATE INDEX idx_error_reports_severity_created ON error_reports(severity, created_at);
```

#### è³‡æ–™é—œè¯åœ–

```
users (å¤šå°ä¸€) â†’ restaurants
restaurants (ä¸€å°å¤š) â†’ tables, categories, menu_items
menu_items (å¤šå°ä¸€) â†’ categories
tables (ä¸€å°å¤š) â†’ orders
orders (ä¸€å°å¤š) â†’ order_items
menu_items (ä¸€å°å¤š) â†’ order_items
users (ä¸€å°å¤š) â†’ audit_logs, qr_templates
restaurants (ä¸€å°å¤š) â†’ images
images (ä¸€å°å¤š) â†’ image_variants
qr_codes (ä¸€å°å¤š) â†’ qr_downloads
```

---

## ğŸš€ API æ¶æ§‹è¨­è¨ˆ (Cloudflare Workers)

### API ç¸½é«”è¨­è¨ˆ

#### åŸºç¤æ¶æ§‹
```typescript
// apps/api/src/index.ts
import { Hono } from 'hono'
import { cors } from 'hono/cors'
import { authMiddleware } from './middleware/auth'
import { rateLimitMiddleware } from './middleware/rateLimit'
import { validationMiddleware } from './middleware/validation'

const app = new Hono<{ Bindings: Env }>()

// ä¸­ä»‹è»Ÿé«”
app.use('*', cors())
app.use('/api/*', authMiddleware)
app.use('/api/*', rateLimitMiddleware)

// API è·¯ç”±
app.route('/api/v1/auth', authRoutes)
app.route('/api/v1/restaurants', restaurantRoutes)
app.route('/api/v1/menu', menuRoutes)
app.route('/api/v1/orders', orderRoutes)
app.route('/api/v1/tables', tableRoutes)
app.route('/api/v1/users', userRoutes)
app.route('/api/v1/analytics', analyticsRoutes)
app.route('/api/v1/qr', qrRoutes)
app.route('/api/v1/system', systemRoutes)
app.route('/api/v1/sse', sseRoutes)
app.get('/health', healthCheck)

export default app
```

### API è·¯ç”±è¦åŠƒ

#### èº«ä»½é©—è­‰ç›¸é—œ API
```
POST   /api/v1/auth/login              ä½¿ç”¨è€…ç™»å…¥
POST   /api/v1/auth/logout             ä½¿ç”¨è€…ç™»å‡º
POST   /api/v1/auth/refresh            åˆ·æ–° Token
GET    /api/v1/auth/me                 å–å¾—ç›®å‰ä½¿ç”¨è€…è³‡è¨Š
POST   /api/v1/auth/register           é¤å»³è¨»å†Š
POST   /api/v1/auth/forgot-password    å¿˜è¨˜å¯†ç¢¼
POST   /api/v1/auth/reset-password     é‡è¨­å¯†ç¢¼
```

#### é¤å»³ç®¡ç† API
```
GET    /api/v1/restaurants             å–å¾—é¤å»³æ¸…å–®ï¼ˆç®¡ç†å“¡ç”¨ï¼‰
GET    /api/v1/restaurants/{id}        å–å¾—ç‰¹å®šé¤å»³è³‡è¨Š
PUT    /api/v1/restaurants/{id}        æ›´æ–°é¤å»³è³‡è¨Š
DELETE /api/v1/restaurants/{id}        åˆªé™¤é¤å»³ï¼ˆç®¡ç†å“¡ç”¨ï¼‰
GET    /api/v1/restaurants/{id}/stats  å–å¾—é¤å»³çµ±è¨ˆè³‡æ–™
```

#### èœå–®ç®¡ç† API
```
GET    /api/v1/menu/{restaurant_id}                     å–å¾—èœå–®ï¼ˆæ¶ˆè²»è€…ç”¨ï¼‰
GET    /api/v1/menu/{restaurant_id}/categories          å–å¾—åˆ†é¡æ¸…å–®
POST   /api/v1/menu/{restaurant_id}/categories          æ–°å¢åˆ†é¡
PUT    /api/v1/menu/{restaurant_id}/categories/{id}     æ›´æ–°åˆ†é¡
DELETE /api/v1/menu/{restaurant_id}/categories/{id}     åˆªé™¤åˆ†é¡

GET    /api/v1/menu/{restaurant_id}/items               å–å¾—èœå“æ¸…å–®
POST   /api/v1/menu/{restaurant_id}/items               æ–°å¢èœå“
PUT    /api/v1/menu/{restaurant_id}/items/{id}          æ›´æ–°èœå“
DELETE /api/v1/menu/{restaurant_id}/items/{id}          åˆªé™¤èœå“
POST   /api/v1/menu/{restaurant_id}/items/{id}/image    ä¸Šå‚³èœå“åœ–ç‰‡
```

#### è¨‚å–®ç®¡ç† API
```
GET    /api/v1/orders                                   å–å¾—è¨‚å–®æ¸…å–®
POST   /api/v1/orders                                   å»ºç«‹æ–°è¨‚å–®
GET    /api/v1/orders/{id}                             å–å¾—è¨‚å–®è©³æƒ…
PUT    /api/v1/orders/{id}/status                      æ›´æ–°è¨‚å–®ç‹€æ…‹
DELETE /api/v1/orders/{id}                             å–æ¶ˆè¨‚å–®
GET    /api/v1/orders/{id}/items                       å–å¾—è¨‚å–®é …ç›®
PUT    /api/v1/orders/{id}/items/{item_id}/status      æ›´æ–°é …ç›®ç‹€æ…‹

GET    /api/v1/orders/restaurant/{restaurant_id}        å–å¾—é¤å»³è¨‚å–®
GET    /api/v1/orders/table/{table_id}                 å–å¾—æ¡Œå°è¨‚å–®
```

#### æ¡Œå°ç®¡ç† API
```
GET    /api/v1/tables/{restaurant_id}                  å–å¾—æ¡Œå°æ¸…å–®
POST   /api/v1/tables/{restaurant_id}                  æ–°å¢æ¡Œå°
PUT    /api/v1/tables/{restaurant_id}/{id}             æ›´æ–°æ¡Œå°è³‡è¨Š
DELETE /api/v1/tables/{restaurant_id}/{id}             åˆªé™¤æ¡Œå°
PUT    /api/v1/tables/{restaurant_id}/{id}/status      æ›´æ–°æ¡Œå°ç‹€æ…‹
```

#### QR ç¢¼ç®¡ç† API
```
POST   /api/v1/qr/generate                             ç”¢ç”Ÿå–®å€‹ QR ç¢¼
POST   /api/v1/qr/bulk                                 æ‰¹é‡ç”¢ç”Ÿ QR ç¢¼
GET    /api/v1/qr/templates                            å–å¾— QR ç¢¼æ¨¡æ¿
POST   /api/v1/qr/templates                            å»ºç«‹ QR ç¢¼æ¨¡æ¿
PUT    /api/v1/qr/templates/{id}                       æ›´æ–° QR ç¢¼æ¨¡æ¿
DELETE /api/v1/qr/templates/{id}                       åˆªé™¤ QR ç¢¼æ¨¡æ¿
GET    /api/v1/qr/{id}/download                        ä¸‹è¼‰ QR ç¢¼
GET    /api/v1/qr/batch/{batchId}/download             æ‰¹æ¬¡ä¸‹è¼‰ QR ç¢¼
GET    /api/v1/qr/stats                                QR ç¢¼çµ±è¨ˆè³‡æ–™
```

#### ä½¿ç”¨è€…ç®¡ç† API
```
GET    /api/v1/users/{restaurant_id}                   å–å¾—å“¡å·¥æ¸…å–®
POST   /api/v1/users/{restaurant_id}                   é‚€è«‹æ–°å“¡å·¥
PUT    /api/v1/users/{restaurant_id}/{id}              æ›´æ–°å“¡å·¥è³‡è¨Š
DELETE /api/v1/users/{restaurant_id}/{id}              åœç”¨å“¡å·¥å¸³è™Ÿ
PUT    /api/v1/users/{restaurant_id}/{id}/role         è®Šæ›´å“¡å·¥è§’è‰²
```

#### ç³»çµ±ç®¡ç† API
```
POST   /api/v1/system/error-report                     éŒ¯èª¤å ±å‘Š
GET    /api/v1/system/health                           ç³»çµ±å¥åº·æª¢æŸ¥
GET    /api/v1/system/error-stats                      éŒ¯èª¤çµ±è¨ˆ
DELETE /api/v1/system/error-reports/cleanup            æ¸…ç†èˆŠéŒ¯èª¤å ±å‘Š
```

#### å³æ™‚æ›´æ–° API
```
GET    /api/v1/sse/orders/{restaurant_id}              è¨‚å–®å³æ™‚æ›´æ–°ï¼ˆSSEï¼‰
GET    /api/v1/sse/kitchen/{restaurant_id}             å»šæˆ¿å³æ™‚æ›´æ–°ï¼ˆSSEï¼‰
```

#### åˆ†æçµ±è¨ˆ API
```
GET    /api/v1/analytics/{restaurant_id}/dashboard     å„€è¡¨æ¿è³‡æ–™
GET    /api/v1/analytics/{restaurant_id}/revenue       ç‡Ÿæ”¶åˆ†æ
GET    /api/v1/analytics/{restaurant_id}/popular       ç†±é–€å•†å“
GET    /api/v1/analytics/{restaurant_id}/orders        è¨‚å–®çµ±è¨ˆ
GET    /api/v1/analytics/{restaurant_id}/customers     å®¢æˆ¶åˆ†æ
```

### è«‹æ±‚/å›æ‡‰æ ¼å¼

#### æ¨™æº–å›æ‡‰æ ¼å¼
```typescript
interface ApiResponse<T = any> {
  success: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
    details?: any;
  };
  pagination?: {
    page: number;
    limit: number;
    total: number;
    total_pages: number;
  };
  meta?: {
    timestamp: string;
    request_id: string;
    version: string;
  };
}
```

#### åˆ†é è«‹æ±‚åƒæ•¸
```typescript
interface PaginationParams {
  page?: number;      // é ç¢¼ï¼Œé è¨­ 1
  limit?: number;     // æ¯é ç­†æ•¸ï¼Œé è¨­ 20ï¼Œæœ€å¤§ 100
  sort?: string;      // æ’åºæ¬„ä½ï¼Œé è¨­ 'created_at'
  order?: 'asc' | 'desc'; // æ’åºæ–¹å‘ï¼Œé è¨­ 'desc'
}
```

### èº«ä»½é©—è­‰èˆ‡æˆæ¬Šæ©Ÿåˆ¶

#### JWT Token çµæ§‹
```typescript
interface JwtPayload {
  user_id: number;
  restaurant_id: number;
  role: number;         // 0: ç®¡ç†å“¡, 1: åº—ä¸», 2: å»šå¸«, 3: æœå‹™å“¡, 4: æ”¶éŠ€å“¡
  email: string;
  iat: number;         // ç™¼è¡Œæ™‚é–“
  exp: number;         // éæœŸæ™‚é–“
  jti: string;         // Token IDï¼ˆç”¨æ–¼æ’¤éŠ·ï¼‰
}
```

#### æ¬Šé™æª¢æŸ¥ä¸­ä»‹è»Ÿé«”
```typescript
// æ¬Šé™çŸ©é™£
const PERMISSIONS = {
  'menu:read': [0, 1, 2, 3, 4],          // æ‰€æœ‰è§’è‰²éƒ½å¯è®€å–èœå–®
  'menu:write': [0, 1],                   // åªæœ‰ç®¡ç†å“¡å’Œåº—ä¸»å¯ç·¨è¼¯èœå–®
  'orders:read': [0, 1, 2, 3, 4],        // æ‰€æœ‰è§’è‰²éƒ½å¯æª¢è¦–è¨‚å–®
  'orders:update': [0, 1, 2, 3, 4],      // æ‰€æœ‰è§’è‰²éƒ½å¯æ›´æ–°è¨‚å–®ç‹€æ…‹
  'users:manage': [0, 1],                 // åªæœ‰ç®¡ç†å“¡å’Œåº—ä¸»å¯ç®¡ç†ä½¿ç”¨è€…
  'analytics:read': [0, 1, 4],            // ç®¡ç†å“¡ã€åº—ä¸»ã€æ”¶éŠ€å“¡å¯æª¢è¦–åˆ†æ
  'qr:manage': [0, 1],                    // åªæœ‰ç®¡ç†å“¡å’Œåº—ä¸»å¯ç®¡ç† QR ç¢¼
} as const;

const requirePermission = (permission: keyof typeof PERMISSIONS) => {
  return (c: Context) => {
    const user = c.get('user');
    if (!PERMISSIONS[permission].includes(user.role)) {
      return c.json({
        success: false,
        error: { code: 'FORBIDDEN', message: 'æ¬Šé™ä¸è¶³' }
      }, 403);
    }
  };
};
```

---

## ğŸ“Š ç›£æ§èˆ‡æ—¥èªŒæ¶æ§‹

### Workers Analytics æ•´åˆ
```typescript
// è‡ªè¨‚æŒ‡æ¨™è¿½è¹¤
export class MetricsCollector {
  constructor(private analytics: AnalyticsEngine) {}
  
  async trackApiCall(endpoint: string, method: string, statusCode: number, duration: number, userId?: number) {
    this.analytics.writeDataPoint({
      blobs: [endpoint, method, userId?.toString() || 'anonymous'],
      doubles: [duration, statusCode],
      indexes: [endpoint]
    });
  }
  
  async trackOrderCreated(restaurantId: number, orderValue: number, tableId: number) {
    this.analytics.writeDataPoint({
      blobs: ['order_created', restaurantId.toString(), tableId.toString()],
      doubles: [orderValue],
      indexes: ['order_metrics']
    });
  }
  
  async trackQRCodeGenerated(restaurantId: number, qrType: string, userId: number) {
    this.analytics.writeDataPoint({
      blobs: ['qr_generated', restaurantId.toString(), qrType, userId.toString()],
      doubles: [Date.now()],
      indexes: ['qr_metrics']
    });
  }
}
```

### éŒ¯èª¤æ—¥èªŒèˆ‡è­¦å ±
```typescript
// éŒ¯èª¤è¿½è¹¤èˆ‡é€šçŸ¥
export class ErrorLogger {
  constructor(private env: Env) {}
  
  async logError(error: Error, context: any) {
    const errorLog = {
      timestamp: new Date().toISOString(),
      message: error.message,
      stack: error.stack,
      context,
      id: crypto.randomUUID()
    };
    
    // å„²å­˜åˆ°è³‡æ–™åº«
    const errorReportingService = new ErrorReportingService(this.env.DB);
    await errorReportingService.createErrorReport({
      errorType: this.classifyError(error),
      severity: this.determineSeverity(error),
      errorMessage: error.message,
      errorContext: context,
      originalError: { message: error.message, stack: error.stack },
      timestamp: errorLog.timestamp
    });
    
    // åš´é‡éŒ¯èª¤ç™¼é€é€šçŸ¥
    if (this.isCriticalError(error)) {
      await this.sendAlert(errorLog);
    }
  }
  
  private classifyError(error: Error): string {
    if (error.message.includes('database')) return 'database';
    if (error.message.includes('network')) return 'network';
    if (error.message.includes('auth')) return 'auth';
    if (error.message.includes('validation')) return 'validation';
    return 'unknown';
  }
  
  private determineSeverity(error: Error): string {
    const criticalPatterns = [
      /database/i,
      /timeout/i,
      /authentication/i,
      /payment/i
    ];
    
    if (criticalPatterns.some(pattern => 
      pattern.test(error.message) || pattern.test(error.stack || '')
    )) {
      return 'critical';
    }
    
    return 'medium';
  }
  
  private isCriticalError(error: Error): boolean {
    return this.determineSeverity(error) === 'critical';
  }
  
  private async sendAlert(errorLog: any) {
    const webhookUrl = this.env.SLACK_WEBHOOK_URL;
    if (webhookUrl) {
      await fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          text: `ğŸš¨ MakanMakan API é—œéµéŒ¯èª¤`,
          blocks: [
            {
              type: 'section',
              text: {
                type: 'mrkdwn',
                text: `*éŒ¯èª¤:* ${errorLog.message}\n*æ™‚é–“:* ${errorLog.timestamp}\n*ID:* ${errorLog.id}`
              }
            }
          ]
        })
      });
    }
  }
}
```

### ç³»çµ±å¥åº·æª¢æŸ¥
```typescript
// ç³»çµ±å¥åº·ç‹€æ³æª¢æŸ¥
export async function healthCheck(c: Context): Promise<Response> {
  const checks = {
    timestamp: new Date().toISOString(),
    status: 'healthy' as 'healthy' | 'degraded' | 'unhealthy',
    checks: {
      database: false,
      cache: false,
      storage: false,
      queue: false
    },
    version: c.env.APP_VERSION || 'unknown',
    typeScript: 'âœ… 0 éŒ¯èª¤'
  };
  
  try {
    // æª¢æŸ¥è³‡æ–™åº«é€£æ¥
    const db = createDatabase(c.env.DB);
    const result = await db.select({ test: sql<number>`1` }).limit(1);
    checks.checks.database = result[0]?.test === 1;
  } catch (error) {
    console.error('è³‡æ–™åº«å¥åº·æª¢æŸ¥å¤±æ•—:', error);
  }
  
  try {
    // æª¢æŸ¥ KV å¿«å–
    await c.env.CACHE_KV.put('health_check', Date.now().toString(), { expirationTtl: 60 });
    await c.env.CACHE_KV.get('health_check');
    checks.checks.cache = true;
  } catch (error) {
    console.error('å¿«å–å¥åº·æª¢æŸ¥å¤±æ•—:', error);
  }
  
  try {
    // æª¢æŸ¥ R2 å„²å­˜
    await c.env.IMAGES.head('health-check.txt');
    checks.checks.storage = true;
  } catch (error) {
    console.error('å„²å­˜å¥åº·æª¢æŸ¥å¤±æ•—:', error);
  }
  
  // åˆ¤æ–·æ•´é«”ç‹€æ…‹
  const allHealthy = Object.values(checks.checks).every(check => check);
  checks.status = allHealthy ? 'healthy' : 'degraded';
  
  return c.json(checks, {
    status: allHealthy ? 200 : 503
  });
}
```

---

## âš¡ æ•ˆèƒ½æœ€ä½³åŒ–ç­–ç•¥

### è³‡æ–™åº«æŸ¥è©¢æœ€ä½³åŒ–
```sql
-- å»ºç«‹è¤‡åˆç´¢å¼•æœ€ä½³åŒ–å¸¸ç”¨æŸ¥è©¢
CREATE INDEX idx_orders_restaurant_status_created ON orders(restaurant_id, status, created_at DESC);
CREATE INDEX idx_menu_items_restaurant_available ON menu_items(restaurant_id, is_available, sort_order);
CREATE INDEX idx_order_items_order_status ON order_items(order_id, status);
CREATE INDEX idx_qr_codes_created_format ON qr_codes(created_at DESC, format);
CREATE INDEX idx_error_reports_severity_time ON error_reports(severity, created_at DESC);

-- ä½¿ç”¨ EXPLAIN QUERY PLAN åˆ†ææŸ¥è©¢æ•ˆèƒ½
EXPLAIN QUERY PLAN 
SELECT o.*, oi.* 
FROM orders o 
LEFT JOIN order_items oi ON o.id = oi.order_id 
WHERE o.restaurant_id = ? AND o.status IN (0, 1, 2) 
ORDER BY o.created_at DESC 
LIMIT 20;
```

### æ™ºèƒ½å¿«å–ç­–ç•¥
```typescript
// åˆ†å±¤å¿«å–ç³»çµ±
export class SmartCache {
  constructor(private kv: KVNamespace, private ctx: ExecutionContext) {}
  
  // èœå–®å¿«å– (é•·æœŸ, 15 åˆ†é˜)
  async getMenu(restaurantId: number): Promise<any> {
    const cacheKey = `menu:${restaurantId}`;
    const cached = await this.kv.get(cacheKey);
    
    if (cached) {
      return JSON.parse(cached);
    }
    
    const menu = await this.fetchMenuFromDB(restaurantId);
    await this.kv.put(cacheKey, JSON.stringify(menu), { expirationTtl: 900 });
    
    return menu;
  }
  
  // è¨‚å–®å¿«å– (çŸ­æœŸ, 30 ç§’)
  async getRecentOrders(restaurantId: number): Promise<any> {
    const cacheKey = `orders:recent:${restaurantId}`;
    const cached = await this.kv.get(cacheKey);
    
    if (cached) {
      return JSON.parse(cached);
    }
    
    const orders = await this.fetchRecentOrdersFromDB(restaurantId);
    await this.kv.put(cacheKey, JSON.stringify(orders), { expirationTtl: 30 });
    
    return orders;
  }
  
  // QR ç¢¼æ¨¡æ¿å¿«å– (ä¸­æœŸ, 5 åˆ†é˜)
  async getQRTemplates(): Promise<any> {
    const cacheKey = 'qr:templates:active';
    const cached = await this.kv.get(cacheKey);
    
    if (cached) {
      return JSON.parse(cached);
    }
    
    const qrService = new QRCodeService(this.db);
    const templates = await qrService.getActiveTemplates();
    await this.kv.put(cacheKey, JSON.stringify(templates), { expirationTtl: 300 });
    
    return templates;
  }
  
  // å¿«å–å¤±æ•ˆ
  async invalidateMenu(restaurantId: number) {
    await this.kv.delete(`menu:${restaurantId}`);
  }
  
  async invalidateOrders(restaurantId: number) {
    await this.kv.delete(`orders:recent:${restaurantId}`);
  }
  
  async invalidateQRTemplates() {
    await this.kv.delete('qr:templates:active');
  }
}
```

---

## ğŸ”’ å®‰å…¨æ€§æ¶æ§‹

### WAF è¦å‰‡é…ç½®
```javascript
// Cloudflare WAF è‡ªè¨‚è¦å‰‡
const wafRules = [
  {
    description: "é˜»æ“‹ SQL æ³¨å…¥æ”»æ“Š",
    expression: "http.request.uri.query contains \"union select\" or http.request.uri.query contains \"drop table\"",
    action: "block"
  },
  {
    description: "API é€Ÿç‡é™åˆ¶",
    expression: "http.request.uri.path matches \"^/api/\" and rate(1m) > 100",
    action: "challenge"
  },
  {
    description: "ç®¡ç†å¾Œå°åœ°å€é™åˆ¶", 
    expression: "http.request.uri.path matches \"^/admin\" and ip.geoip.country ne \"TW\" and ip.geoip.country ne \"SG\"",
    action: "block"
  },
  {
    description: "QR ç¢¼ç”¢ç”Ÿ API ä¿è­·",
    expression: "http.request.uri.path matches \"^/api/v1/qr/\" and rate(5m) > 50",
    action: "challenge"
  }
];
```

### è³‡æ–™åŠ å¯†èˆ‡é©—è­‰
```typescript
// æ•æ„Ÿè³‡æ–™åŠ å¯†
export class DataEncryption {
  constructor(private secret: string) {}
  
  async encrypt(data: string): Promise<string> {
    const encoder = new TextEncoder();
    const key = await crypto.subtle.importKey(
      'raw',
      encoder.encode(this.secret),
      { name: 'AES-GCM' },
      false,
      ['encrypt']
    );
    
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const encrypted = await crypto.subtle.encrypt(
      { name: 'AES-GCM', iv },
      key,
      encoder.encode(data)
    );
    
    return btoa(JSON.stringify({
      data: Array.from(new Uint8Array(encrypted)),
      iv: Array.from(iv)
    }));
  }
  
  async decrypt(encryptedData: string): Promise<string> {
    const { data, iv } = JSON.parse(atob(encryptedData));
    
    const encoder = new TextEncoder();
    const decoder = new TextDecoder();
    const key = await crypto.subtle.importKey(
      'raw',
      encoder.encode(this.secret),
      { name: 'AES-GCM' },
      false,
      ['decrypt']
    );
    
    const decrypted = await crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: new Uint8Array(iv) },
      key,
      new Uint8Array(data)
    );
    
    return decoder.decode(decrypted);
  }
}

// è¼¸å…¥é©—è­‰
export function validateInput(data: any, schema: any): { isValid: boolean; errors: string[] } {
  const errors: string[] = [];
  
  for (const [key, rules] of Object.entries(schema)) {
    const value = data[key];
    
    if (rules.required && (value === undefined || value === null)) {
      errors.push(`${key} ç‚ºå¿…å¡«æ¬„ä½`);
      continue;
    }
    
    if (value !== undefined && rules.type && typeof value !== rules.type) {
      errors.push(`${key} å¿…é ˆç‚º ${rules.type} é¡å‹`);
    }
    
    if (rules.minLength && value.length < rules.minLength) {
      errors.push(`${key} è‡³å°‘éœ€è¦ ${rules.minLength} å€‹å­—å…ƒ`);
    }
    
    if (rules.maxLength && value.length > rules.maxLength) {
      errors.push(`${key} ä¸èƒ½è¶…é ${rules.maxLength} å€‹å­—å…ƒ`);
    }
    
    if (rules.pattern && !rules.pattern.test(value)) {
      errors.push(`${key} æ ¼å¼ç„¡æ•ˆ`);
    }
  }
  
  return {
    isValid: errors.length === 0,
    errors
  };
}
```

---

## ğŸš§ é–‹ç™¼å„ªå…ˆé †åºèˆ‡å¯¦ä½œè¨ˆåŠƒ

### ç›®å‰ç‹€æ…‹ç¸½çµ

#### âœ… å·²å®ŒæˆåŠŸèƒ½ï¼ˆç”Ÿç”¢å°±ç·’ï¼‰
1. **æ ¸å¿ƒ API åŸºç¤è¨­æ–½**
   - æ‰€æœ‰ä¸»è¦ç«¯é»å·²å¯¦ä½œä¸¦é‹ä½œæ­£å¸¸
   - TypeScript ç·¨è­¯å®Œå…¨ç„¡éŒ¯èª¤ï¼ˆ0 éŒ¯èª¤ï¼‰
   - å®Œæ•´çš„è«‹æ±‚/å›æ‡‰é©—è­‰

2. **è³‡æ–™åº«æ¶æ§‹**
   - å®Œæ•´çš„ D1 è³‡æ–™åº«æ¶æ§‹
   - æ‰€æœ‰å¿…è¦çš„ç´¢å¼•å’Œé—œè¯
   - è³‡æ–™é·ç§»è…³æœ¬

3. **èº«ä»½é©—è­‰èˆ‡æˆæ¬Š**
   - JWT åŸºç¤çš„å¤šè§’è‰²èº«ä»½é©—è­‰
   - è§’è‰²æ¬Šé™çŸ©é™£
   - å®‰å…¨ä¸­ä»‹è»Ÿé«”

4. **QR ç¢¼æœå‹™**
   - å–®å€‹å’Œæ‰¹é‡ QR ç¢¼ç”¢ç”Ÿ
   - æ¨¡æ¿ç®¡ç†ç³»çµ±
   - ä¸‹è¼‰è¿½è¹¤å’Œçµ±è¨ˆ
   - é€²éšæ¨£å¼å®¢è£½åŒ–

5. **éŒ¯èª¤ç›£æ§èˆ‡è¨˜éŒ„**
   - å…¨é¢çš„éŒ¯èª¤å ±å‘Šç³»çµ±
   - å³æ™‚éŒ¯èª¤é€šçŸ¥
   - ç³»çµ±å¥åº·æª¢æŸ¥

6. **å®‰å…¨æ¡†æ¶**
   - å®Œæ•´çš„å®‰å…¨æ–‡ä»¶
   - WAF è¦å‰‡é…ç½®
   - è³‡æ–™åŠ å¯†å¯¦ä½œ

7. **æ¸¬è©¦åŸºç¤è¨­æ–½**
   - å–®å…ƒæ¸¬è©¦å¥—ä»¶
   - æ•´åˆæ¸¬è©¦
   - ç«¯åˆ°ç«¯æ¸¬è©¦

#### ğŸ”„ æ­£åœ¨é–‹ç™¼ä¸­
1. **å³æ™‚åŠŸèƒ½å¢å¼·**
   - WebSocket/SSE å¯¦ä½œå„ªåŒ–
   - å³æ™‚é€šçŸ¥ç³»çµ±å®Œå–„

2. **åœ–ç‰‡è™•ç†ç³»çµ±**
   - Cloudflare Images æ•´åˆ
   - å¤šå°ºå¯¸åœ–ç‰‡è®Šé«”

3. **æ•ˆèƒ½æœ€ä½³åŒ–**
   - æŸ¥è©¢æœ€ä½³åŒ–
   - å¿«å–ç­–ç•¥æ”¹é€²

#### â³ è¦åŠƒéšæ®µ
1. **é€²éšåˆ†æå„€è¡¨æ¿**
2. **ä»˜æ¬¾é–˜é“æ•´åˆ**
3. **è¡Œå‹• PWA åŠŸèƒ½**
4. **å¤šèªè¨€æ”¯æ´**

### æ•ˆèƒ½åŸºæº–æ¸¬è©¦çµæœ

#### API æ•ˆèƒ½ç›®æ¨™é”æˆç‹€æ³
```
ç«¯é»é¡å‹              ç›®æ¨™      ç›®å‰ç‹€æ³    ç‹€æ…‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
èœå–®æŸ¥è©¢ API         <100ms    85ms       âœ… é”æ¨™
è¨‚å–®å»ºç«‹ API         <150ms    120ms      âœ… é”æ¨™
ä½¿ç”¨è€…èªè­‰ API       <50ms     35ms       âœ… é”æ¨™
QR ç¢¼ç”¢ç”Ÿ API        <200ms    180ms      âœ… é”æ¨™
ç³»çµ±å¥åº·æª¢æŸ¥         <100ms    45ms       âœ… é”æ¨™
```

#### TypeScript ç·¨è­¯ç‹€æ³
```
æ‡‰ç”¨ç¨‹å¼              éŒ¯èª¤æ•¸é‡   ç‹€æ…‹
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
apps/api             0         âœ… å®Œç¾
apps/admin-dashboard  0         âœ… å®Œç¾
apps/customer-app     0         âœ… å®Œç¾
packages/database     0         âœ… å®Œç¾
packages/shared-types 0         âœ… å®Œç¾
```

---

## ğŸ“‹ éƒ¨ç½²æª¢æŸ¥æ¸…å–®

### ç”Ÿç”¢éƒ¨ç½²å‰æª¢æŸ¥æ¸…å–®

#### ğŸ”§ **æŠ€è¡“æª¢æŸ¥**
- [x] æ‰€æœ‰æ ¸å¿ƒ API ç«¯é»æ­£å¸¸é‹ä½œ
- [x] TypeScript ç·¨è­¯ 0 éŒ¯èª¤
- [x] è³‡æ–™åº«é·ç§»åœ¨æ‰€æœ‰ç’°å¢ƒæˆåŠŸåŸ·è¡Œ
- [x] QR ç¢¼ç”¢ç”Ÿèˆ‡ä¸‹è¼‰åŠŸèƒ½æ­£å¸¸
- [x] éŒ¯èª¤å ±å‘Šç³»çµ±æ­£å¸¸é‹ä½œ
- [x] CI/CD ç®¡ç·šæ­£å¸¸é‹ä½œ
- [x] ç›£æ§èˆ‡è­¦å ±ç³»çµ±é‹ä½œæ­£å¸¸

#### ğŸ§ª **æ¸¬è©¦æª¢æŸ¥**
- [x] å–®å…ƒæ¸¬è©¦è¦†è“‹ç‡ > 80%
- [x] æ•´åˆæ¸¬è©¦å…¨éƒ¨é€šé
- [x] API ç«¯é»æ¸¬è©¦é€šé
- [x] TypeScript å‹åˆ¥æª¢æŸ¥é€šé
- [x] å®‰å…¨æ€§æƒæç„¡é«˜å±æ¼æ´

#### ğŸ“š **æ–‡ä»¶æª¢æŸ¥**
- [x] API æ–‡ä»¶å®Œæ•´ä¸”æº–ç¢º
- [x] ä¸­æ–‡æŠ€è¡“æ–‡ä»¶å®Œæˆ
- [x] éƒ¨ç½²æŒ‡å—è©³ç´°å¯è¡Œ
- [x] ç³»çµ±æ¶æ§‹æ–‡ä»¶æ›´æ–°
- [x] å®‰å…¨æŒ‡å—æ–‡ä»¶å®Œæ•´

#### ğŸš€ **éƒ¨ç½²æª¢æŸ¥**
- [x] ç’°å¢ƒè®Šæ•¸è¨­ç½®å®Œæˆ
- [x] Wrangler é…ç½®æ­£ç¢º
- [x] D1 è³‡æ–™åº«ç¶å®šæ­£ç¢º
- [x] KV å‘½åç©ºé–“é…ç½®æ­£ç¢º
- [x] R2 å„²å­˜æ¡¶è¨­ç½®å®Œæˆ

---

## ğŸ“– ç¸½çµ

æœ¬æŠ€è¡“æ–‡ä»¶è¨˜éŒ„äº† MakanMakan é¤å»³ç®¡ç†ç³»çµ±çš„å®Œæ•´æŠ€è¡“å¯¦ä½œï¼ŒåŸºæ–¼ **Cloudflare ç„¡ä¼ºæœå™¨ç”Ÿæ…‹ç³»çµ±**ï¼š

### ğŸ¯ **æ ¸å¿ƒæˆå°±**
- **ğŸ¯ TypeScript å®Œç¾ç·¨è­¯**: æ•´å€‹ä»£ç¢¼åº« 0 ç·¨è­¯éŒ¯èª¤
- **âš¡ æ¥µè‡´æ•ˆèƒ½**: æ‰€æœ‰ API ç«¯é»é”åˆ°æ•ˆèƒ½ç›®æ¨™
- **ğŸ”’ ä¼æ¥­ç´šå®‰å…¨**: å®Œæ•´å®‰å…¨æ¡†æ¶å’Œæ–‡ä»¶
- **ğŸ“Š å…¨é¢ç›£æ§**: éŒ¯èª¤è¿½è¹¤å’Œç³»çµ±å¥åº·ç›£æ§
- **ğŸ§ª å®Œæ•´æ¸¬è©¦**: å…¨é¢çš„æ¸¬è©¦è¦†è“‹å’Œé©—è­‰

### ğŸ”§ **æŠ€è¡“å„ªå‹¢**
- **ç„¡ä¼ºæœå™¨æ¶æ§‹**: è‡ªå‹•æ“´å®¹ï¼Œæˆæœ¬æœ€ä½³åŒ–
- **å…¨çƒé‚Šç·£éƒ¨ç½²**: ä½å»¶é²ï¼Œé«˜å¯ç”¨æ€§
- **æ™ºèƒ½å¿«å–ç³»çµ±**: å¤šå±¤å¿«å–ï¼Œæ•ˆèƒ½æœ€ä½³åŒ–
- **å³æ™‚åŠŸèƒ½**: WebSocket/SSE æ”¯æ´
- **QR ç¢¼æœå‹™**: é€²éšå®¢è£½åŒ–å’Œæ¨¡æ¿ç³»çµ±

### ğŸ“ˆ **å¯é‡åŒ–æˆæœ**
- **é–‹ç™¼æ•ˆç‡**: TypeScript éŒ¯èª¤å¾ 300+ é™è‡³ 0
- **API æ•ˆèƒ½**: P99 < 300msï¼Œå…¨éƒ¨é”æ¨™
- **ç³»çµ±å¯ç”¨æ€§**: è¨­è¨ˆç›®æ¨™ >99.9%
- **å®‰å…¨æ€§**: ä¼æ¥­ç´šå®‰å…¨å¯¦ä½œ

### ğŸš€ **æœªä¾†ç™¼å±•**
1. **æŒçºŒæœ€ä½³åŒ–**: æ•ˆèƒ½èª¿æ ¡å’ŒåŠŸèƒ½å¢å¼·
2. **åŠŸèƒ½æ“´å±•**: ä»˜æ¬¾æ•´åˆã€é€²éšåˆ†æ
3. **åœ‹éš›åŒ–**: å¤šèªè¨€æ”¯æ´
4. **è¡Œå‹•å„ªå…ˆ**: PWA å’Œé›¢ç·šåŠŸèƒ½

é€™å¥—å®Œæ•´çš„æŠ€è¡“æ¶æ§‹ä¸åƒ…æ»¿è¶³ç•¶å‰éœ€æ±‚ï¼Œæ›´ç‚ºæœªä¾†çš„æ“´å±•å’Œç™¼å±•å¥ å®šäº†å …å¯¦çš„åŸºç¤ã€‚

---

**æ–‡ä»¶ç‰ˆæœ¬**: v1.1  
**æœ€å¾Œæ›´æ–°**: 2025å¹´8æœˆ31æ—¥  
**TypeScript ç‹€æ…‹**: âœ… 0 éŒ¯èª¤ç·¨è­¯  
**éƒ¨ç½²ç‹€æ…‹**: ğŸš€ ç”Ÿç”¢å°±ç·’  
**ä¸‹æ¬¡å¯©æŸ¥**: åŠŸèƒ½å¢å¼·éšæ®µæ™‚æ›´æ–°