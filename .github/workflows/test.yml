name: ğŸ§ª MakanMakan æ¸¬è©¦æµæ°´ç·š

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '10'

jobs:
  # ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  lint-and-typecheck:
    name: ğŸ“ ç¨‹å¼ç¢¼æª¢æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ”§ è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ğŸ“¦ å®‰è£ pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: ğŸ“¥ å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile
        
      - name: ğŸ” ESLint æª¢æŸ¥
        run: pnpm run lint
        
      - name: ğŸ¯ TypeScript å‹åˆ¥æª¢æŸ¥
        run: pnpm run typecheck
        
      - name: ğŸ’… Prettier æ ¼å¼æª¢æŸ¥
        run: pnpm exec prettier --check "**/*.{ts,js,vue,json,md}"

  # å–®å…ƒæ¸¬è©¦
  unit-tests:
    name: ğŸ§ª å–®å…ƒæ¸¬è©¦
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    
    strategy:
      matrix:
        node-version: [18, 20]
    
    steps:
      - name: ğŸ“¦ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ”§ è¨­ç½® Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'
          
      - name: ğŸ“¦ å®‰è£ pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: ğŸ“¥ å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile
        
      - name: ğŸ§ª åŸ·è¡Œå–®å…ƒæ¸¬è©¦
        run: pnpm run test:unit
        
      - name: ğŸ“Š ç”¢ç”Ÿè¦†è“‹ç‡å ±å‘Š
        run: pnpm run test:coverage
        
      - name: â˜‚ï¸ ä¸Šå‚³è¦†è“‹ç‡åˆ° Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: unit-tests
          name: unit-tests-node-${{ matrix.node-version }}
          
      - name: ğŸ“ ä¸Šå‚³æ¸¬è©¦çµæœ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results-node-${{ matrix.node-version }}
          path: |
            coverage/
            test-results/
          retention-days: 7

  # Cloudflare Workers æ¸¬è©¦
  workers-tests:
    name: âš¡ Workers æ¸¬è©¦
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    
    steps:
      - name: ğŸ“¦ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ”§ è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ğŸ“¦ å®‰è£ pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: ğŸ“¥ å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile
        
      - name: ğŸ”§ å®‰è£ Wrangler CLI
        run: pnpm add -g wrangler
        
      - name: âš¡ æ¸¬è©¦ Cloudflare Workers
        run: pnpm run test:workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          
      - name: ğŸ“Š Workers æ•´åˆæ¸¬è©¦
        run: pnpm run test:workers:integration
        env:
          TEST_D1_DATABASE: ${{ secrets.TEST_D1_DATABASE }}
          TEST_KV_NAMESPACE: ${{ secrets.TEST_KV_NAMESPACE }}

  # E2E æ¸¬è©¦
  e2e-tests:
    name: ğŸ­ E2E æ¸¬è©¦
    runs-on: ubuntu-latest
    needs: [unit-tests, workers-tests]
    
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        
    steps:
      - name: ğŸ“¦ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ”§ è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ğŸ“¦ å®‰è£ pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: ğŸ“¥ å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile
        
      - name: ğŸ­ å®‰è£ Playwright
        run: npx playwright install --with-deps ${{ matrix.browser }}
        
      - name: ğŸ—ï¸ å»ºç½®æ‡‰ç”¨ç¨‹å¼
        run: pnpm run build
        
      - name: ğŸš€ å•Ÿå‹•æ¸¬è©¦æœå‹™å™¨
        run: |
          pnpm run preview &
          echo $! > server.pid
          
      - name: â³ ç­‰å¾…æœå‹™å™¨å•Ÿå‹•
        run: npx wait-on http://localhost:4173 --timeout 60000
        
      - name: ğŸ§ª åŸ·è¡Œ E2E æ¸¬è©¦ (${{ matrix.browser }})
        run: npx playwright test --project=${{ matrix.browser }}
        env:
          E2E_BASE_URL: http://localhost:4173
          
      - name: ğŸ›‘ åœæ­¢æ¸¬è©¦æœå‹™å™¨
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi
          
      - name: ğŸ“ ä¸Šå‚³æ¸¬è©¦å ±å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}
          path: playwright-report/
          retention-days: 7
          
      - name: ğŸ“¸ ä¸Šå‚³æ¸¬è©¦æˆªåœ–
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-screenshots-${{ matrix.browser }}
          path: test-results/
          retention-days: 7

  # æ•ˆèƒ½æ¸¬è©¦
  performance-tests:
    name: ğŸš€ æ•ˆèƒ½æ¸¬è©¦
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¦ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ”§ è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ğŸ“¦ å®‰è£ pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: ğŸ“¥ å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile
        
      - name: ğŸ—ï¸ å»ºç½®æ‡‰ç”¨ç¨‹å¼
        run: pnpm run build
        
      - name: ğŸš€ æ•ˆèƒ½æ¸¬è©¦ (Lighthouse CI)
        run: |
          pnpm add -g @lhci/cli@0.12.x
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  # å®‰å…¨æ€§æ¸¬è©¦
  security-tests:
    name: ğŸ” å®‰å…¨æ€§æ¸¬è©¦
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    
    steps:
      - name: ğŸ“¦ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ” ä¾è³´æ¼æ´æƒæ
        run: pnpm audit --audit-level high
        
      - name: ğŸ”’ CodeQL åˆ†æ
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          
      - name: ğŸ” åŸ·è¡Œ CodeQL åˆ†æ
        uses: github/codeql-action/analyze@v3

  # æ¸¬è©¦çµæœå½™ç¸½
  test-summary:
    name: ğŸ“Š æ¸¬è©¦çµæœå½™ç¸½
    runs-on: ubuntu-latest
    needs: [unit-tests, workers-tests, e2e-tests]
    if: always()
    
    steps:
      - name: ğŸ“¦ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ ä¸‹è¼‰æ¸¬è©¦çµæœ
        uses: actions/download-artifact@v4
        with:
          path: test-artifacts
          
      - name: ğŸ“Š ç”¢ç”Ÿæ¸¬è©¦å ±å‘Š
        run: |
          echo "## ğŸ§ª æ¸¬è©¦çµæœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æª¢æŸ¥å„é …æ¸¬è©¦ç‹€æ…‹
          if [ "${{ needs.unit-tests.result }}" == "success" ]; then
            echo "âœ… å–®å…ƒæ¸¬è©¦: é€šé" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ å–®å…ƒæ¸¬è©¦: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.workers-tests.result }}" == "success" ]; then
            echo "âœ… Workers æ¸¬è©¦: é€šé" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Workers æ¸¬è©¦: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.e2e-tests.result }}" == "success" ]; then
            echo "âœ… E2E æ¸¬è©¦: é€šé" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ E2E æ¸¬è©¦: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ æ¸¬è©¦å ±å‘Šå’Œæˆªåœ–è«‹æŸ¥çœ‹ Artifacts å€åŸŸ" >> $GITHUB_STEP_SUMMARY

  # éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ (åƒ…åœ¨æ‰€æœ‰æ¸¬è©¦é€šéæ™‚)
  deploy-staging:
    name: ğŸš€ éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ
    runs-on: ubuntu-latest
    needs: [unit-tests, workers-tests, e2e-tests, security-tests]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: staging
    
    steps:
      - name: ğŸ“¦ Checkout ç¨‹å¼ç¢¼
        uses: actions/checkout@v4
        
      - name: ğŸ”§ è¨­ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: ğŸ“¦ å®‰è£ pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          
      - name: ğŸ“¥ å®‰è£ä¾è³´
        run: pnpm install --frozen-lockfile
        
      - name: ğŸ—ï¸ å»ºç½®æ‡‰ç”¨ç¨‹å¼
        run: pnpm run build
        
      - name: ğŸš€ éƒ¨ç½²åˆ° Cloudflare (Staging)
        run: pnpm run deploy:staging
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          
      - name: ğŸ§ª éƒ¨ç½²å¾Œç…™éœ§æ¸¬è©¦
        run: npm run test:smoke:staging
        env:
          STAGING_URL: ${{ secrets.STAGING_URL }}